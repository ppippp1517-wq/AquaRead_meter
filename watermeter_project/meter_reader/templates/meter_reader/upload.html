{% extends "meter_reader/base_app.html" %}
{% load static %}
{% block title %}AquaRead – อัปโหลด/ตรวจจับค่ามิเตอร์{% endblock %}

{% block head %}
<style>
  :root{
    --ink:#0f172a;
    --muted:#64748b;
    --card:#fff;
    --border:#e5e7eb;
    --primary:#0f172a;
    --primary-soft:#e0f2fe;
  }

  body{
    background:#f7fafc;
    color:var(--ink);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    font-size:14px;
    line-height:1.5;
  }

  .wrap{
    max-width:960px;
    margin:0 auto;
    padding:12px 14px 24px;
  }

  /* ===== App bar ด้านบน (แทนแถบโล่ง ๆ เดิม) ===== */
  .topbar{
    position:sticky;
    top:0;
    z-index:10;
    background:#fff;
    border-bottom:1px solid var(--border);
  }
  .topbar .inner{
    max-width:960px;
    margin:0 auto;
    padding:8px 12px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .topbar-title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .topbar-title-main{
    font-size:15px;
    font-weight:700;
  }
  .topbar-title-sub{
    font-size:12px;
    color:var(--muted);
  }
  .spacer{ flex:1; }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    color:var(--ink);
    cursor:pointer;
    text-decoration:none;
    font-size:14px;
    white-space:nowrap;
  }
  .btn.primary{
    background:var(--primary);
    color:#fff;
    border-color:var(--primary);
  }
  .btn.link{
    border:none;
    background:transparent;
    color:var(--primary);
    text-decoration:none;
    padding-left:0;
  }
  .btn-icon{
    width:34px;
    height:34px;
    padding:0;
    border-radius:999px;
    font-size:18px;
    line-height:1;
  }
  .btn:disabled{
    opacity:.6;
    cursor:not-allowed;
  }

  /* การ์ด / layout */
  .grid{ display:grid; gap:16px; }
  .cols-2{ grid-template-columns:2fr 1.4fr; }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px 12px;
    box-shadow:0 4px 10px rgba(15,23,42,0.04);
  }
  .card h3{
    margin:0 0 .4rem;
    font-size:16px;
  }
  .muted{ color:var(--muted); }

  .input{
    border:1px solid var(--border);
    border-radius:10px;
    padding:9px 10px;
    background:#fff;
    color:var(--ink);
    font-size:14px;
  }
  .inline{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .sep{ height:1px; background:var(--border); margin:10px 0; }

  /* ตารางทั่วไป */
  .table{
    width:100%;
    border-collapse:collapse;
  }
  .table th,
  .table td{
    padding:8px 10px;
    border-top:1px solid var(--border);
    text-align:left;
    font-size:13px;
  }
  .table thead th{
    background:#f8fafc;
    color:#334155;
    border-top:0;
  }

  /* preview ภาพ */
  .preview{
    max-width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    display:block;
  }
  .preview-holder{ margin-top:10px; }

  /* การ์ดสรุปผลลัพธ์ให้ดูเป็นแอพมากขึ้น */
  .result-summary{
    display:flex;
    flex-direction:column;
    gap:4px;
    margin-bottom:8px;
  }
  .result-total-label{
    font-size:12px;
    font-weight:600;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.03em;
  }
  .result-total-value{
    font-size:26px;
    font-weight:800;
  }
  .result-badges{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:4px;
  }
  .badge{
    padding:3px 8px;
    border-radius:999px;
    background:#f1f5f9;
    font-size:11px;
    color:#0f172a;
  }

  /* ประวัติ: ให้แสดงเป็นการ์ดในจอเล็ก */
  @media (max-width:640px){
    .cols-2{ grid-template-columns:1fr; }
    .wrap{ padding:10px 10px 24px; }

    .table.history thead{
      display:none;
    }
    .table.history,
    .table.history tbody,
    .table.history tr,
    .table.history td{
      display:block;
      width:100%;
    }
    .table.history tr{
      background:#fff;
      border-radius:14px;
      margin-bottom:8px;
      box-shadow:0 2px 6px rgba(15,23,42,0.05);
      overflow:hidden;
    }
    .table.history td{
      border:none;
      border-top:1px solid var(--border);
      padding:6px 10px;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .table.history td:first-child{
      border-top:none;
      padding-top:8px;
    }
    .table.history td:last-child{
      padding-bottom:8px;
    }
    .table.history td::before{
      content:attr(data-label);
      font-weight:600;
      color:var(--muted);
    }
  }

  @media (max-width:480px){
    .topbar .inner{
      padding:8px 10px;
    }
    .topbar-title-main{ font-size:14px; }
    .card{ padding:12px 10px; }
  }
</style>
{% endblock %}

{% block content %}



    {% if user.is_authenticated %}
      
    {% else %}
      <a class="btn" href="{% url 'login' %}?next={% url 'upload_image' %}">เข้าสู่ระบบ</a>
    {% endif %}
  </div>
</div>

<div class="wrap grid cols-2">

  <!-- ซ้าย: แบบฟอร์มอัปโหลด -->
  <section class="grid" style="gap:16px">

    <!-- ภาพเดี่ยว -->
    <article class="card">
      <h3>อัปโหลดภาพเดี่ยว</h3>
      <div class="muted" style="margin-bottom:8px">รองรับ JPEG/PNG</div>

      <form method="POST" enctype="multipart/form-data" class="grid" style="gap:10px">
        {% csrf_token %}
        <div class="inline">
          <label for="file-upload" class="btn">เลือกไฟล์</label>
          <input id="file-upload" type="file" name="image" accept="image/*" required style="display:none">
          <input class="input" style="min-width:180px" type="text" name="meter_id"
                 value="{{ request.POST.meter_id|default:'SPP-01' }}" placeholder="Meter ID">
          <button class="btn primary" type="submit">Detect</button>
        </div>
        <div class="muted" id="file-name"></div>
        <div id="preview-holder" class="preview-holder" style="display:none">
          <img id="preview-image" class="preview" alt="Preview">
        </div>
      </form>
    </article>

    <!-- โฟลเดอร์ -->
    <article class="card">
      <h3>อัปโหลดทั้งโฟลเดอร์ภาพ</h3>
      <div class="muted" style="margin-bottom:8px">เลือกทั้งโฟลเดอร์แล้วกด Detect Folder</div>

      <form method="POST" action="{% url 'upload_folder' %}" enctype="multipart/form-data"
            class="grid" style="gap:10px">
        {% csrf_token %}
        <div class="inline">
          <label for="folder-upload" class="btn">เลือกโฟลเดอร์</label>
          <input id="folder-upload" type="file" name="images" webkitdirectory multiple required style="display:none">
          <input class="input" style="min-width:180px" type="text" name="meter_id"
                 value="{{ request.POST.meter_id|default:'SPP-01' }}" placeholder="Meter ID">
          <button class="btn primary" type="submit">Detect Folder</button>
        </div>
        <div class="muted" id="folder-count"></div>
      </form>
    </article>

    <!-- Webcam -->
    <article class="card">
      <h3>ถ่ายภาพจาก Webcam</h3>
      <div class="muted" style="margin-bottom:8px">กดปุ่มเพื่อเปิดหน้าถ่ายภาพ</div>
      <form method="GET" action="{% url 'preview_image' %}" class="inline">
        <button type="submit" class="btn primary">Capture Image</button>
      </form>
    </article>

    {% if csv_path %}
      <article class="card">
        <div class="inline" style="justify-content:space-between">
          <div class="muted">ดาวน์โหลดผลลัพธ์</div>
          <a class="btn" href="{{ csv_path }}" download>ดาวน์โหลด CSV</a>
        </div>
      </article>
    {% endif %}
  </section>

  <!-- ขวา: ผลลัพธ์ / รายละเอียด / ประวัติ -->
  <aside class="grid" style="gap:16px">

    {% if base64_image %}
      <article class="card">
        <h3>Preview ภาพที่ถ่าย</h3>
        <img src="{{ base64_image }}" class="preview" alt="Preview">
        <div class="inline" style="margin-top:10px">
          <form method="POST" action="{% url 'confirm_image' %}">
            {% csrf_token %}
            <button type="submit" class="btn primary">ใช้ภาพนี้</button>
          </form>
          <a href="{% url 'preview_image' %}" class="btn">ถ่ายใหม่</a>
        </div>
      </article>
    {% endif %}

    {% if result and image_url %}
      <article class="card">
        <h3>ภาพที่ตรวจจับแล้ว</h3>
        <img src="{{ image_url }}" class="preview" alt="Detected Image">

        <div class="sep"></div>
        {% url 'detection_detail' result.stem as detail_url %}
        <a target="_blank" class="btn link"
           href="{{ detail_url }}?digit_string={{ result.digit_string|urlencode }}
&digital_x={{ result.digital_x|urlencode }}
&x01={{ result.x01|urlencode }}
&x001={{ result.x001|urlencode }}
&x0001={{ result.x0001|urlencode }}
&x00001={{ result.x00001|urlencode }}
&total={{ result.total|urlencode }}
&prev_x01={{ result.prev_reading.x01|default_if_none:''|urlencode }}
&prev_x001={{ result.prev_reading.x001|default_if_none:''|urlencode }}
&prev_x0001={{ result.prev_reading.x0001|default_if_none:''|urlencode }}
&prev_x00001={{ result.prev_reading.x00001|default_if_none:''|urlencode }}
&raw_digital={{ result.raw_digits.digital_x_raw|default_if_none:''|urlencode }}
&raw_x01={{ result.raw_digits.x01_raw|default_if_none:''|urlencode }}
&raw_x001={{ result.raw_digits.x001_raw|default_if_none:''|urlencode }}
&raw_x0001={{ result.raw_digits.x0001_raw|default_if_none:''|urlencode }}
&raw_x00001={{ result.raw_digits.x00001_raw|default_if_none:''|urlencode }}
&final_digital={{ result.final_digits.digital_x|default_if_none:''|urlencode }}
&final_x01={{ result.final_digits.x01|default_if_none:''|urlencode }}
&final_x001={{ result.final_digits.x001|default_if_none:''|urlencode }}
&final_x0001={{ result.final_digits.x0001|default_if_none:''|urlencode }}
&final_x00001={{ result.final_digits.x00001|default_if_none:''|urlencode }}">
          แสดงรายละเอียด →
        </a>
      </article>
    {% endif %}

    {% if result %}
      <article class="card">
        <h3>ผลการตรวจจับ</h3>

        <!-- การ์ดสรุปค่า Total ให้เด่น -->
        <div class="result-summary">
          <div class="result-total-label">Total Usage</div>
          <div class="result-total-value">{{ result.total }} m³</div>
          <div class="result-badges">
            <span class="badge">Digital: {{ result.digital_x }}</span>
            <span class="badge">x01: {{ result.x01|default:"-" }}</span>
            <span class="badge">x001: {{ result.x001 }}</span>
            <span class="badge">x0001: {{ result.x0001 }}</span>
            <span class="badge">x00001: {{ result.x00001 }}</span>
          </div>
        </div>

        <table class="table">
          <thead><tr><th>ตำแหน่ง</th><th>ค่าอ่าน</th></tr></thead>
          <tbody>
            <tr><td>Digital</td><td>{{ result.digital_x }}</td></tr>
            <tr><td>x01</td><td>{{ result.x01|default:"-" }}</td></tr>
            <tr><td>x001</td><td>{{ result.x001 }}</td></tr>
            <tr><td>x0001</td><td>{{ result.x0001 }}</td></tr>
            <tr><td>x00001</td><td>{{ result.x00001 }}</td></tr>
            <tr><td><strong>Total</strong></td><td><strong>{{ result.total }} m³</strong></td></tr>
          </tbody>
        </table>
      </article>
    {% endif %}

    <article class="card">
      <h3>ประวัติการอ่านล่าสุด</h3>
      <table class="table history">
        <thead>
          <tr><th>วันที่</th><th>ไฟล์</th><th>Total (m³)</th></tr>
        </thead>
        <tbody>
          {% for item in recent_results %}
            <tr>
              <td data-label="วันที่">{{ item.date }}</td>
              <td data-label="ไฟล์">{{ item.filename }}</td>
              <td data-label="Total">{{ item.total }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="muted">- ไม่มีข้อมูล -</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </article>
  </aside>
</div>

<!-- JS: พรีวิวไฟล์/นับไฟล์โฟลเดอร์ -->
<script>
  window.addEventListener("DOMContentLoaded", function () {
    // single file preview
    const fileInput = document.getElementById("file-upload");
    const fileNameDisplay = document.getElementById("file-name");
    const holder = document.getElementById("preview-holder");
    const preview = document.getElementById("preview-image");

    fileInput?.addEventListener("change", function () {
      const file = fileInput.files[0];
      if (file && file.type.startsWith("image/")) {
        fileNameDisplay.textContent = "ไฟล์ที่เลือก: " + file.name;
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          holder.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        fileNameDisplay.textContent = "";
        holder.style.display = "none";
        preview.src = "";
      }
    });

    // folder count
    const folderInput = document.getElementById("folder-upload");
    const folderCountDisplay = document.getElementById("folder-count");
    folderInput?.addEventListener("change", function () {
      const count = folderInput.files.length;
      folderCountDisplay.textContent = count ? ("จำนวนไฟล์ที่เลือก: " + count + " ไฟล์") : "";
    });
  });
</script>

{% endblock %}
